<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sheets Data with Search and Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- โหลดไลบรารี Chart.js -->
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #2c1f57;  /* สีม่วงเข้ม */
            color: white;
            padding: 20px;
        }
        #chartContainer {
            margin-top: 30px;
        }
        .search-container {
            text-align: center;
            margin-bottom: 20px;
        }
        #myChart {
            max-width: 600px;
            margin: 0 auto;
        }
        .error-message {
            color: red;
            text-align: center;
        }
    </style>
</head>
<body>

    <div class="search-container">
        <input type="text" id="peaSearch" placeholder="ค้นหาจาก PEA หรือพิมพ์ 'ทั้งหมด'" style="padding: 10px;">
        <button onclick="searchData()">ค้นหา</button>
    </div>

    <div id="errorMessage" class="error-message"></div> <!-- แสดงข้อความเตือนเมื่อไม่พบข้อมูล -->

    <div id="chartContainer">
        <canvas id="myChart"></canvas> <!-- แสดงกราฟ -->
    </div>

    <script>
        // URL ของ Web App ของ Google Apps Script ที่ดึงข้อมูลจาก Google Sheets
        const SHEET_URL = 'https://script.google.com/macros/s/AKfycbxlaaf8OoWyn9VXPjAhZq5jKUYmIJR791bkaRR7hA8p94S-R2CnqPDj95Gz5rsKjZC0/exec';

        // ฟังก์ชันในการดึงข้อมูลจาก Google Sheets
        async function fetchData() {
            try {
                const response = await fetch(SHEET_URL);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        // ฟังก์ชันในการแสดงกราฟ
        function displayChart(data) {
            const labels = data.map(item => item.pea);  // ใช้ PEA เป็น labels
            const ratios = data.map(item => parseFloat(item.ratio));  // ใช้ อัตราส่วน เป็นข้อมูลกราฟ

            if (labels.length === 0 || ratios.length === 0) {
                alert('ไม่พบข้อมูลที่ใช้ในการสร้างกราฟ');
                return;  // ถ้าไม่มีข้อมูลให้หยุดการทำงาน
            }

            const ctx = document.getElementById('myChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'อัตราส่วน',
                        data: ratios,
                        backgroundColor: '#f5c518',  // สีทอง
                        borderColor: '#2c1f57',  // สีม่วงเข้ม
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // ฟังก์ชันในการค้นหาข้อมูลจาก PEA
        async function searchData() {
            const searchQuery = document.getElementById('peaSearch').value.trim();
            const errorMessageElement = document.getElementById('errorMessage');
            errorMessageElement.innerHTML = ''; // ล้างข้อความเตือนก่อน

            const allData = await fetchData();

            if (!allData) {
                return;
            }

            let filteredData = allData;

            // ค้นหาข้อมูลจาก PEA หรือแสดงทั้งหมด
            if (searchQuery && searchQuery.toLowerCase() !== 'ทั้งหมด') {
                filteredData = allData.filter(item => item.pea.toLowerCase().includes(searchQuery.toLowerCase()));
            }

            // ถ้าไม่พบข้อมูล
            if (filteredData.length === 0) {
                errorMessageElement.innerHTML = 'ไม่พบข้อมูลที่ตรงกับการค้นหา';
                document.getElementById('myChart').style.display = 'none';  // ซ่อนกราฟ
            } else {
                document.getElementById('myChart').style.display = 'block';  // แสดงกราฟ
                displayChart(filteredData);  // แสดงกราฟด้วยข้อมูลที่กรองแล้ว
            }
        }
    </script>

</body>
</html>
